## Настройка файлового хранилища Samba с авторизацией. Ubuntu 18.04

Научимся устанавливать и настраивать файловый сервер **Samba**. Это ПО известно тем, что для доступа к файлам использует протокол **SMB** - протокол работы с файловым серверам от Microsoft. На самом деле сейчас Samba умеет не только работать файловым сервером, но еще и контроллером доменов, совместимым с Microsoft Active Directory с немного урезанными групповыми политиками.

Настраивать будем на **Ubuntu 18.04 LTS**. Руководство подойдет для организации численностью до 50 человек.

Обновим базу пакетов:
```sudo apt-get update ```

>На боевом сервере лучше сделать бекап перед тем как обновляешь что-либо

Установка самого сервера Samba призводится командой:
```sudo apt-get install samba ```

Идем в папку с конфигурационными файлами Samba. Там будет лежать демонстрационная конфигурация (*smb.conf*).

```cd /etc/samba ```

В данной руководстве будем писать свою конфигурацию, поэтому дефолтную можем сохранить и почитать на досуге.
Создаем свой конфигурационный файл и файл содержащий логины и пароли (в зашифрованном виде):

```sudo touch smb.conf```<br>
```sudo touch smbusers```

Создадим папку, которую будем расшаривать в сеть:
```sudo mkdir /opt/FirstTestShare ```<br>
```sudo chmod 777 /opt/FirstTestShare```<br>

Открываем **smb.conf** и приступаем к редактированию<br>

Конфигурация сервера состоит из нескольких секций. Основная секция **[global]** и каждая шара будет настроена отдельной секцией, также обозначенной квадратными скобками. К примеру **[share1]**, **[share2]**, **[Music]**, **[Video]** и т.д.<br>

Сначала **[global]**<br>

***[global]***<br>

*### Identification ###*<br>
*server string = %h server (Samba, Ubuntu)*<br>   
*workgroup = WORKGROUP* # Идентификатор в сетевом окружении<br>  

*### Authentification ###*<br>
*server role = standalone server* **# Роль - обычный файловый сервер.**<br>  
*security = user* **# Тип авторизации. Сущ. 3 типа:user, domain, share.**<br>     
*passdb backend = smbpasswd* **# Тип БД пользователей**<br>   
*smb passwd file = /etc/samba/smbusers* **# Файл БД пользователей**<br>  
*encrypt passwords = yes*               **#  Разрешаем шифрованние паролей**<br>  
*map to guest = bad user*               **# Запрещаем гостевой вход**<br>  

*### Logs ###*<br>  
*log file = /var/log/samba/log.%m* # Указываем файл, в который будут писаться логи сервиса.<br>  
*syslog = 3* # Уровень логирования. Чем выше, тем подробнее логи. Не злоупотреблять.<br>

***[FirstTestShare]***
*comment = Our Test Share* # Всплывающая подсказка, при наведении на  сетевую папку.<br>  
*path = /opt/FirstTestShare* # Путь к расшариваемой папке.<br>  
*browseable = yes* # Видимость папки. Чтобы сделать скрытой поставбте no.<br>  
*writeable = yes* # Разрешаем запись в нашу папку<br>  
*create mask = 0775* # Определяем права, которые будут выдаваться файлам, залитым на шару.<br>  
*directory mask = 0775*# Права для директорий.<br>  
<br>
После чего сохраняем файл и перезапускаем сервер Samba командой:    
```sudo service smbd restart ``` <br>

Также добавим его в автозагрузку, для того, чтобы каждый раз его не включать:  
```sudo systemctl enable smbd``` <br>   
 
 Теперь в сетевом окружении можем видеть нашу расшаренную папку. Если этого не произошло необходимо:
 + Включить сетевое обнаружение и общий доступ к папкам на Windows.  
 + Включить протокол smb1 в компонентах Windows(для старых машин).
 + Попробовать ввести в стандартном проводнике Windows в ручную ip сервера(В моем случае сервер - виртуалка в режиме сетевого моста):  
 ```\\ip вашего сервера```
 
 Создаем пользователей для доступа к папке:  
 ```sudo useradd -c "samba_n1" -s /sbin/nologin test1```  
 ```sudo useradd -c "samba_n2" -s /sbin/nologin test2```  
 ```sudo useradd -c "samba_n3" -s /sbin/nologin test3```
 
 Параметр **-s /sbin/nologin** означает, что эти пользователи не имеют права логиниться в консоль сервера. Это важно с точки зрения безопасности.  
   
 Зададим им пароли:  
 ```sudo smbpasswd -a test1 ```  
 ```sudo smbpasswd -a test2 ```  
 ```sudo smbpasswd -a test3 ```  
 
 Теперь любой пользователь может зайти в папку.
 
 
 
 
 
 


