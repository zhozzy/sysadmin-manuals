## Настройка файлового хранилища Samba с авторизацией. Ubuntu 18.04
### Брифинг  
+ Установить сервис
  + ```sudo apt install samba```
+ Создать папки с пользователями и файл конфигурации в конфигах сервиса (/etc/samba)
+ Создать расшариваемую папку
  + ```sudo mkdir /opt/FirstTestShare```
  + ```sudo chmod -R 777 /opt/FirstTestShare```
+ [Редактирование файла конфигурации](#link)  
+ Создание пользователей и паролей
  + ```sudo useradd -c "samba_n1" -s /sbin/nologin test1```
  + ```sudo smbpasswd -a test1```

### Полное руководство  

Научимся устанавливать и настраивать файловый сервер **Samba**. Это ПО известно тем, что для доступа к файлам использует протокол **SMB** - протокол работы с файловым серверам от Microsoft. На самом деле сейчас Samba умеет не только работать файловым сервером, но еще и контроллером доменов, совместимым с Microsoft Active Directory с немного урезанными групповыми политиками.

Настраивать будем на **Ubuntu 18.04 LTS**. Руководство подойдет для организации численностью до 50 человек.

Обновим базу пакетов:
```sudo apt-get update ```

>На боевом сервере лучше сделать бекап перед тем как обновляешь что-либо

Установка самого сервера Samba призводится командой:
```sudo apt-get install samba ```

Идем в папку с конфигурационными файлами Samba. Там будет лежать демонстрационная конфигурация (*smb.conf*).

```cd /etc/samba ```

В данной руководстве будем писать свою конфигурацию, поэтому дефолтную можем сохранить и почитать на досуге.
Создаем свой конфигурационный файл и файл содержащий логины и пароли (в зашифрованном виде):

```sudo touch smb.conf```<br>
```sudo touch smbusers```

Создадим папку, которую будем расшаривать в сеть:<br>
```sudo mkdir /opt/FirstTestShare ```<br>
```sudo chmod 777 /opt/FirstTestShare```<br>
 <a name="link"></a>
Открываем **smb.conf** и приступаем к редактированию<br>

Конфигурация сервера состоит из нескольких секций. Основная секция **[global]** и каждая шара будет настроена отдельной секцией, также обозначенной квадратными скобками. К примеру **[share1]**, **[share2]**, **[Music]**, **[Video]** и т.д.<br>

***[global]***

*### Identification ###*  
*server string = %h server (Samba, Ubuntu)*     
*workgroup = WORKGROUP* # Идентификатор в сетевом окружении<br>  

*### Authentification ###*  
*server role = standalone server* **# Роль - обычный файловый сервер.**   
*security = user* **# Тип авторизации. Сущ. 3 типа:user, domain, share.**      
*passdb backend = smbpasswd* **# Тип БД пользователей**   
*smb passwd file = /etc/samba/smbusers* **# Файл БД пользователей**    
*encrypt passwords = yes*               **#  Разрешаем шифрованние паролей**    
*map to guest = bad user*               **# Запрещаем гостевой вход**   

*### Logs ###*  
*log file = /var/log/samba/log.%m* **# Указываем файл, в который будут писаться логи сервиса.**    
*syslog = 3* **# Уровень логирования. Чем выше, тем подробнее логи. Не злоупотреблять.**  

***[FirstTestShare]***  
*comment = Our Test Share* **# Всплывающая подсказка, при наведении на  сетевую папку.**   
*path = /opt/FirstTestShare* **# Путь к расшариваемой папке.**    
*browseable = yes* **# Видимость папки. Чтобы сделать скрытой поставбте no.**    
*writeable = yes* **# Разрешаем запись в нашу папку**    
*create mask = 0775* **# Определяем права, которые будут выдаваться файлам, залитым на шару.**    
*directory mask = 0775* **# Права для директорий.**

Перед тем как запускать сервис, надо проверить конфигурационный файл на корректность. У многих развитых пакетов ПО есть утилита для такой задачи. Есть она и в пакете samba.

```testparm -s``` 

Если оно выдало ошибку, то надо исправить. Повторять до того, пока ошибки не перестанут выводиться.

После чего сохраняем файл и перезапускаем сервер Samba командой:    
```sudo service smbd restart ``` <br>

Также добавим его в автозагрузку, для того, чтобы каждый раз его не включать:  
```sudo systemctl enable smbd``` <br>   
 
 Теперь в сетевом окружении можем видеть нашу расшаренную папку. Если этого не произошло необходимо:
 + Включить сетевое обнаружение и общий доступ к папкам на Windows.  
 + Включить протокол smb1 в компонентах Windows(для старых машин).
 + Попробовать ввести в стандартном проводнике Windows в ручную ip сервера(В моем случае сервер - виртуалка в режиме сетевого моста):  
 ```\\ip вашего сервера```
 
 Создаем пользователей для доступа к папке:  
 ```sudo useradd -c "samba_n1" -s /sbin/nologin test1```  
 ```sudo useradd -c "samba_n2" -s /sbin/nologin test2```  
 ```sudo useradd -c "samba_n3" -s /sbin/nologin test3```
 
 Параметр **-s /sbin/nologin** означает, что эти пользователи не имеют права логиниться в консоль сервера. Это важно с точки зрения безопасности.  
   
 Зададим им пароли:  
 ```sudo smbpasswd -a test1 ```  
 ```sudo smbpasswd -a test2 ```  
 ```sudo smbpasswd -a test3 ```  
 
 Теперь любой пользователь может зайти в папку.
 
 Рассмотрим ситуацию.


 В организации работал бухгалтер test1. Но время идет, фирма растет, нагрузка растет.

И вот наняли ему в помощь test2.

Пользователь test2 заходит на шару в папку Buh и может все файлы просматривать,

но не может их редактировать.
 
Дело в том, что у нас create mask и directory mask настроены так, что файлы пользователя 

может редактировать либо он, либо кто-то из общей с ним группы. Для всех остальных только чтение.

По умолчанию при создании пользователя под него в системе создается одноименная группа. 

Получается что у нас пользователь test1 в группе test1, а пользователь test2 в группе test2.

Для пользователя test1 в данной ситуации пользователь test2 относится к категории "другие". 
 
Нам требуется групповая работа над файлами. Значит будем настраивать общую группу для 

пользователей test1 и test2.

Делается это так.

1. Создаем новую группу командой:


sudo groupadd buh


2. Устанавливаем группу buh по умолчанию для пользователей test1 и test2


sudo usermod -aG buh test1

sudo usermod -aG buh test2


3. И перезапускаем samba, чтобы пользователи перелогинились на шару (иначе новые настройки не применятся)


sudo service smbd restart


4. Меняем настройки владельца для всех файлов, которые уже были созданы и для самой папки Buh


sudo chown -R test1:buh /opt/FirstTestShare/Buh 
 
Пользователь test2 теперь может редактировать файлы в папке Buh, наряду с test1. К подобной групповой работе можно подключить любого другого пользователя, добавив его в группу buh.

Не совсем. Новая ситуация.

Шли дни, месяцы, недели. Пользователи test1 и test2 работали и все было прекрасно, до одного момента.

Открывает однажды пользователь test2 очень важный отчет, чтобы его отредактировать и видит уведомление

от текстового редактора "Файл заблокирован на запись пользователем test1. Открыт в режиме только чтение". Вот это поворот!

Дело в том, что test1 любит работать с разных компьютеров. И на каком-то из них он не закрыл этот файл.

А как найти на каком именно? Тут нам поможет утилита диагностики  smbstatus.

Вывод программы можно разделить на три части:


1. Список открытых сессий (один пользователь можешь открыть их несколько как с одного компьютера, так и с нескольких). Ключевое поле тут PID. Это идентификатор сессии.

2. Список открытых шар, с указанием pid сессии. 

3. Список заблокированных на запись файлов.


Для нас будет полезно знать, что PID сессии равнозначен Proccess ID в ОС Linux. Запомним эту информацию. Она нам пригодится через пару мгновений

Заблокированный файл в 3-м разделе будет иметь статус DENY_WRITE в поле DenyMode.


Смотрим PID, идем в первый раздел и видим IP-компьютера. Мы можем попросить человека закрыть файл.

А если нет возможности попросить?

Тогда мы освободим файл принудительно. Вы еще помните, что PID сессии равнозначен PID процесса в ОС?


Этим мы и воспользуемся. Находим PID залоченного файла и выполняем в консоли команду 


sudo kill -9 PID


Тем самым мы принудительно завершили процесс, занимающий наш файл. Теперь можно его открывать и редактировать.
